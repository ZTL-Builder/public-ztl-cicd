name: ZTL-MK1 Unified Build

on:
  repository_dispatch:
    types: [build-request]
  workflow_dispatch:
    inputs:
      private_repo_ref:
        description: "Private repo branch or commit"
        required: false
        default: "main"
        type: string
      build_platforms:
        description: "Platforms to build (linux,windows,macos)"
        required: false
        default: "linux,windows,macos"
        type: string
      customer_name:
        description: "ZTL Unique ID (e.g. ZTLMK1-2UFPG2)"
        required: true
        type: string
      upload_to_s3:
        description: "Upload binaries to S3"
        required: false
        default: true
        type: boolean

env:
  APP_NAME: ztl
  AWS_REGION: ap-south-1
  AWS_S3_BUCKET: ztl-exe
  CARGO_TERM_COLOR: always

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      build_linux: ${{ steps.platforms.outputs.build_linux }}
      build_windows: ${{ steps.platforms.outputs.build_windows }}
      build_macos: ${{ steps.platforms.outputs.build_macos }}
      private_repo_ref: ${{ steps.inputs.outputs.private_repo_ref }}
      customer_name: ${{ steps.inputs.outputs.customer_name }}
      s3_prefix: ${{ steps.inputs.outputs.s3_prefix }}
    steps:
      - name: Parse inputs
        id: inputs
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            PRIVATE_REPO_REF="${{ github.event.client_payload.private_repo_ref || 'main' }}"
            BUILD_PLATFORMS="${{ github.event.client_payload.build_platforms || 'linux,windows,macos' }}"
            CUSTOMER_NAME="${{ github.event.client_payload.customer_name || '' }}"
            UPLOAD_TO_S3="${{ github.event.client_payload.upload_to_s3 || 'true' }}"
          else
            PRIVATE_REPO_REF="${{ github.event.inputs.private_repo_ref || 'main' }}"
            BUILD_PLATFORMS="${{ github.event.inputs.build_platforms || 'linux,windows,macos' }}"
            CUSTOMER_NAME="${{ github.event.inputs.customer_name || '' }}"
            UPLOAD_TO_S3="${{ github.event.inputs.upload_to_s3 || 'true' }}"
          fi

          echo "private_repo_ref=$PRIVATE_REPO_REF" >> $GITHUB_OUTPUT
          echo "customer_name=$CUSTOMER_NAME" >> $GITHUB_OUTPUT
          echo "upload_to_s3=$UPLOAD_TO_S3" >> $GITHUB_OUTPUT

          # ‚úÖ Fixed S3 structure
          if [ -n "$CUSTOMER_NAME" ]; then
            S3_PREFIX="ztlmk1/$CUSTOMER_NAME"
          else
            S3_PREFIX="ztlmk1/unknown"
          fi
          echo "s3_prefix=$S3_PREFIX" >> $GITHUB_OUTPUT

          echo "‚úÖ Parsed inputs:"
          echo "  Repo ref: $PRIVATE_REPO_REF"
          echo "  Platforms: $BUILD_PLATFORMS"
          echo "  ZTL ID: $CUSTOMER_NAME"
          echo "  S3 prefix: $S3_PREFIX"

      - name: Determine build platforms
        id: platforms
        run: |
          BUILD_PLATFORMS="${{ github.event.client_payload.build_platforms || github.event.inputs.build_platforms || 'linux,windows,macos' }}"
          [[ "$BUILD_PLATFORMS" == *"linux"* ]] && echo "build_linux=true" >> $GITHUB_OUTPUT || echo "build_linux=false" >> $GITHUB_OUTPUT
          [[ "$BUILD_PLATFORMS" == *"windows"* ]] && echo "build_windows=true" >> $GITHUB_OUTPUT || echo "build_windows=false" >> $GITHUB_OUTPUT
          [[ "$BUILD_PLATFORMS" == *"macos"* ]] && echo "build_macos=true" >> $GITHUB_OUTPUT || echo "build_macos=false" >> $GITHUB_OUTPUT

  linux-build:
    name: üêß Linux Build
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.build_linux == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            arch: x86_64
          - target: aarch64-unknown-linux-gnu
            arch: aarch64
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO_NAME }}
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: ${{ needs.setup.outputs.private_repo_ref }}
          path: source

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: source

      - name: Build binary
        working-directory: source
        run: |
          echo "üî® Building Linux binary..."
          cargo build --release --target ${{ matrix.target }}
          mkdir -p dist
          cp target/${{ matrix.target }}/release/${{ env.APP_NAME }} dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to S3
        working-directory: source
        run: |
          aws s3 cp dist/ s3://${{ env.AWS_S3_BUCKET }}/${{ needs.setup.outputs.s3_prefix }}/linux/${{ matrix.arch }}/ --recursive
          echo "‚úÖ Uploaded Linux (${{ matrix.arch }}) binaries"

  windows-build:
    name: ü™ü Windows Build
    runs-on: windows-latest
    needs: setup
    if: needs.setup.outputs.build_windows == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO_NAME }}
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: ${{ needs.setup.outputs.private_repo_ref }}
          path: source

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: source

      - name: Build binary
        working-directory: source
        shell: pwsh
        run: |
          cargo build --release --target x86_64-pc-windows-msvc
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item "target/x86_64-pc-windows-msvc/release/${{ env.APP_NAME }}.exe" dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to S3
        working-directory: source
        shell: pwsh
        run: |
          aws s3 cp dist/ s3://${{ env.AWS_S3_BUCKET }}/${{ needs.setup.outputs.s3_prefix }}/windows/x86_64/ --recursive
          Write-Host "‚úÖ Uploaded Windows binaries"

  macos-build:
    name: üçé macOS Build
    runs-on: ${{ matrix.runner }}
    needs: setup
    if: needs.setup.outputs.build_macos == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            runner: macos-13
            arch: x86_64
          - target: aarch64-apple-darwin
            runner: macos-14
            arch: aarch64
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO_NAME }}
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: ${{ needs.setup.outputs.private_repo_ref }}
          path: source

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: source

      - name: Build binary
        working-directory: source
        run: |
          cargo build --release --target ${{ matrix.target }}
          mkdir -p dist
          cp target/${{ matrix.target }}/release/${{ env.APP_NAME }} dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to S3
        working-directory: source
        run: |
          aws s3 cp dist/ s3://${{ env.AWS_S3_BUCKET }}/${{ needs.setup.outputs.s3_prefix }}/macos/${{ matrix.arch }}/ --recursive
          echo "‚úÖ Uploaded macOS (${{ matrix.arch }}) binaries"

  notify:
    name: üì© Telegram Notification
    runs-on: ubuntu-latest
    needs: [setup, linux-build, windows-build, macos-build]
    if: always()
    steps:
      - name: Send Telegram message
        run: |
          CHAT_ID="${{ github.event.client_payload.telegram_chat_id || secrets.TELEGRAM_CHAT_ID }}"
          MSG="‚úÖ ZTL build completed for ID: *${{ needs.setup.outputs.customer_name }}*\n\
          üìÇ S3: s3://${{ env.AWS_S3_BUCKET }}/${{ needs.setup.outputs.s3_prefix }}/\n\
          üêß Linux: linux/\nü™ü Windows: windows/\nüçé macOS: macos/"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="$CHAT_ID" \
          -d parse_mode="Markdown" \
          -d text="$MSG"
